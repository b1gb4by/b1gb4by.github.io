<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>IAM Configuration Changes and Custom Service Account Implementation When Migrating to Cloud Functions Gen2 | BigBaBy's Blog</title><meta name=keywords content="Google Cloud,Cloud Functions,Cloud Run,IAM,Terraform,Service Account"><meta name=description content="This article shares the IAM configuration differences encountered when migrating Cloud Functions from 1st generation to 2nd generation, and the implementation methods for custom service accounts based on actual experience."><meta name=author content="BigBaBy"><link rel=canonical href=https://b1gb4by.github.io/posts/2025-08-04-terraform-custom-sa-cloud-functions/><link crossorigin=anonymous href=/assets/css/stylesheet.7fd3fe01bee3c2eeba19ecfe798062b9c72970465733ef3aaf1c0ab20f39375e.css integrity="sha256-f9P+Ab7jwu66Gez+eYBiuccpcEZXM+86rxwKsg85N14=" rel="preload stylesheet" as=style><link rel=icon href=https://b1gb4by.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://b1gb4by.github.io/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://b1gb4by.github.io/favicon.ico><link rel=apple-touch-icon href=https://b1gb4by.github.io/apple-touch-icon.png><link rel=mask-icon href=https://b1gb4by.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=ja href=https://b1gb4by.github.io/ja/posts/2025-08-04-terraform-custom-sa-cloud-functions/><link rel=alternate hreflang=en href=https://b1gb4by.github.io/posts/2025-08-04-terraform-custom-sa-cloud-functions/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://b1gb4by.github.io/posts/2025-08-04-terraform-custom-sa-cloud-functions/"><meta property="og:site_name" content="BigBaBy's Blog"><meta property="og:title" content="IAM Configuration Changes and Custom Service Account Implementation When Migrating to Cloud Functions Gen2"><meta property="og:description" content="This article shares the IAM configuration differences encountered when migrating Cloud Functions from 1st generation to 2nd generation, and the implementation methods for custom service accounts based on actual experience."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-04T12:34:36+00:00"><meta property="article:modified_time" content="2025-08-04T12:34:36+00:00"><meta property="article:tag" content="Google Cloud"><meta property="article:tag" content="Cloud Functions"><meta property="article:tag" content="Cloud Run"><meta property="article:tag" content="IAM"><meta property="article:tag" content="Terraform"><meta property="article:tag" content="Service Account"><meta name=twitter:card content="summary"><meta name=twitter:title content="IAM Configuration Changes and Custom Service Account Implementation When Migrating to Cloud Functions Gen2"><meta name=twitter:description content="This article shares the IAM configuration differences encountered when migrating Cloud Functions from 1st generation to 2nd generation, and the implementation methods for custom service accounts based on actual experience."><meta name=twitter:site content="@taisuke_bigbaby"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://b1gb4by.github.io/posts/"},{"@type":"ListItem","position":2,"name":"IAM Configuration Changes and Custom Service Account Implementation When Migrating to Cloud Functions Gen2","item":"https://b1gb4by.github.io/posts/2025-08-04-terraform-custom-sa-cloud-functions/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"IAM Configuration Changes and Custom Service Account Implementation When Migrating to Cloud Functions Gen2","name":"IAM Configuration Changes and Custom Service Account Implementation When Migrating to Cloud Functions Gen2","description":"This article shares the IAM configuration differences encountered when migrating Cloud Functions from 1st generation to 2nd generation, and the implementation methods for custom service accounts based on actual experience.","keywords":["Google Cloud","Cloud Functions","Cloud Run","IAM","Terraform","Service Account"],"articleBody":"Recently, I had the opportunity to migrate existing Cloud Functions from 1st generation to 2nd generation. During this process, I was surprised to find that the IAM configuration had changed more than expected, and the setup method for custom service accounts was also different from the 1st generation.\nIn this article, I‚Äôll share the technical insights gained from the actual migration work and the configurations required to get everything working properly.\nTarget Audience Those using Cloud Functions on Google Cloud Those considering or implementing migration from 1st to 2nd generation Those managing Cloud Functions with Terraform Initial Problem Encountered: Changes in IAM Resource Types The first stumbling block in migrating to 2nd generation was that the Terraform IAM resources were completely different.\n1st Generation Configuration (Traditional Method) # This is how we wrote it in 1st generation resource \"google_cloudfunctions_function_iam_member\" \"invoker\" { project = var.project_id region = \"asia-northeast1\" cloud_function = \"my-function\" role = \"roles/cloudfunctions.invoker\" member = \"serviceAccount:${var.service_account_email}\" } 2nd Generation Configuration (Using Cloud Run Resources) # In 2nd generation, we need to use Cloud Run resources resource \"google_cloud_run_service_iam_member\" \"invoker\" { project = var.project_id location = \"asia-northeast1\" service = \"my-function\" # Function name becomes the service name role = \"roles/run.invoker\" # The role has changed too! member = \"serviceAccount:${var.service_account_email}\" } The reason for this change is that 2nd generation Cloud Functions now runs on a Cloud Run base1. In other words, it‚Äôs internally treated as a Cloud Run service.\nDifferences in Roles Between 1st and 2nd Generation (This is Important!) What I struggled with most during the migration was that the required roles had changed significantly. After investigating the official Google Cloud documentation, the following differences became clear:\nRoles Required for Deployment 1st Generation:\nresource \"google_project_iam_member\" \"cloud_build_permissions_gen1\" { for_each = toset([ \"roles/cloudfunctions.developer\", # Cloud Functions developer \"roles/iam.serviceAccountUser\", # Service account usage permission ]) project = var.project_id role = each.value member = \"serviceAccount:${google_service_account.cloud_build.email}\" } 2nd Generation2:\nresource \"google_project_iam_member\" \"cloud_build_permissions_gen2\" { for_each = toset([ \"roles/cloudfunctions.developer\", # Cloud Functions developer (still needed) \"roles/run.admin\", # Cloud Run admin permission additionally required! \"roles/iam.serviceAccountUser\", # Service account usage permission \"roles/eventarc.admin\", # Required when using Pub/Sub triggers \"roles/artifactregistry.reader\", # Access to container images ]) project = var.project_id role = each.value member = \"serviceAccount:${google_service_account.cloud_build.email}\" } Roles Required for Execution 1st Generation:\nroles/cloudfunctions.invoker - To invoke the function 2nd Generation3:\nroles/run.invoker - To invoke as a Cloud Run service4 roles/eventarc.eventReceiver - When receiving Eventarc events other than Pub/Sub5 If you migrate without understanding these differences, you‚Äôll end up in a situation where ‚Äúit should have permissions but it doesn‚Äôt work.‚Äù In particular, the need for roles/run.admin was a point that‚Äôs hard to notice without understanding the official documentation stating that ‚ÄúCloud Functions 2nd generation runs on Cloud Run infrastructure‚Äù6.\nService Account Changes Another important change is that the default runtime service account has changed7:\n1st Generation:\nRuntime: PROJECT_ID@appspot.gserviceaccount.com (App Engine default) 2nd Generation:\nRuntime: PROJECT_NUMBER-compute@developer.gserviceaccount.com (Compute Engine default) Lessons Learned from Custom Service Account Implementation Issues with Default Service Account By default, PROJECT_NUMBER-compute@developer.gserviceaccount.com is used, but this account has Editor permissions8. From a security perspective, I decided to create a dedicated service account.\nWorking Configuration Here‚Äôs a generalized version of the configuration that worked properly in the actual project:\n# Service account for Cloud Build (executes deployment) resource \"google_service_account\" \"cloud_build\" { account_id = \"cloud-build-deployer\" project = var.project_id display_name = \"Cloud Build Deployer\" description = \"Service account for deploying Cloud Functions\" } # Service account for Cloud Functions runtime resource \"google_service_account\" \"cloud_functions\" { account_id = \"cf-my-function\" project = var.project_id display_name = \"Cloud Functions Runtime\" description = \"Service account used at Cloud Functions runtime\" } Required Permission Settings This is a crucial point. Since Cloud Build needs to use the Cloud Functions service account to execute deployment, granting roles/iam.serviceAccountUser permission was necessary9:\n# Permission for Cloud Build to use Functions service account resource \"google_service_account_iam_member\" \"cloud_build_act_as\" { service_account_id = google_service_account.cloud_functions.name role = \"roles/iam.serviceAccountUser\" member = \"serviceAccount:${google_service_account.cloud_build.email}\" } This permission allows the Cloud Build service account to specify the Cloud Functions service account as the runtime identity for Cloud Functions. Without this configuration, you‚Äôll get permission errors during deployment.\nSpecial Cases Encountered with Pub/Sub Triggers Pub/Sub Service Account Format When using Pub/Sub triggers, the following configuration was necessary:\nresource \"google_cloud_run_service_iam_member\" \"pubsub_invoker\" { project = var.project_id location = \"asia-northeast1\" service = \"my-function\" role = \"roles/run.invoker\" member = \"serviceAccount:service-${var.project_number}@gcp-sa-pubsub.iam.gserviceaccount.com\" } Note that you must use PROJECT_NUMBER, not PROJECT_ID. I didn‚Äôt notice this at first and wondered why I was getting permission errors.\nWhy Pub/Sub IAM Configuration Became Complex Upon investigation, I found that in 2nd generation, Pub/Sub triggers now operate through Eventarc10. According to the official documentation, roles/eventarc.admin permission is required when creating Eventarc triggers11, and the trigger service account needs roles/run.invoker permission12.\nAdditional Requirements When Deploying via Cloud Build After checking the official documentation, I found that when deploying Gen2 functions via Cloud Build, the following additional permissions were also required13:\n# Additional permissions required for Cloud Build service account resource \"google_project_iam_member\" \"cloud_build_additional\" { for_each = toset([ \"roles/storage.objectViewer\", # Access to source code \"roles/logging.logWriter\", # Write build logs ]) project = var.project_id role = each.value member = \"serviceAccount:${google_service_account.cloud_build.email}\" } Cloud Build Deployment Configuration The actual Cloud Build configuration used (generalized):\nsteps: - id: deploy cloud function name: gcr.io/google.com/cloudsdktool/cloud-sdk entrypoint: 'bash' args: - '-c' - | gcloud functions deploy my-function \\ --gen2 \\ --region=asia-northeast1 \\ --trigger-topic=my-topic \\ --runtime=nodejs20 \\ --entry-point=main \\ --service-account=${_CF_SERVICE_ACCOUNT}@${PROJECT_ID}.iam.gserviceaccount.com The --gen2 flag and --service-account option are important.\nSecret Manager Integration (Additional Discovery) Benefits of Using Secret Manager Instead of Environment Variables During the migration work, I noticed that Secret Manager integration has become easier to use in 2nd generation2.\n# Access permissions for Secret Manager resource \"google_secret_manager_secret_iam_member\" \"function_secrets\" { for_each = toset([ \"API_KEY\", \"DATABASE_PASSWORD\", ]) project = var.project_id secret_id = each.value role = \"roles/secretmanager.secretAccessor\" member = \"serviceAccount:${google_service_account.cloud_functions.email}\" } Deployment configuration:\n--set-secrets=\"API_KEY=API_KEY:latest\" \\ --set-secrets=\"DB_PASSWORD=DATABASE_PASSWORD:latest\" This eliminated the need to set sensitive information directly in environment variables.\nLessons Learned from Migration 1. Relationship Between Function Name and Cloud Run Service Name In 2nd generation, the deployed function name becomes the Cloud Run service name as is. Without understanding this, you‚Äôll be confused when setting up IAM.\n2. Distinguishing Between PROJECT_NUMBER and PROJECT_ID Especially for Pub/Sub service accounts, you must use PROJECT_NUMBER:\nCorrect: service-123456789@gcp-sa-pubsub.iam.gserviceaccount.com Wrong: service-my-project-id@gcp-sa-pubsub.iam.gserviceaccount.com 3. Debugging Permission Errors When permission errors occur, checking the following in Cloud Logging makes it easier to identify the cause:\nWhich service account is being used Which roles are missing Whether the resource name (especially Cloud Run service name) is correct Summary The migration to Cloud Functions 2nd generation involved major changes in the following areas:\nIAM resource type change: From google_cloudfunctions_function_iam_member to google_cloud_run_service_iam_member Role change: From roles/cloudfunctions.invoker to roles/run.invoker Additional required roles: roles/run.admin, roles/eventarc.admin, roles/artifactregistry.reader Pub/Sub trigger complexity: Additional configuration due to operating through Eventarc Default service account change: From App Engine default to Compute Engine default Custom service account permissions: Need for roles/iam.serviceAccountUser These changes stem from 2nd generation being based on Cloud Run. The official documentation clearly states that ‚ÄúCloud Functions 2nd generation runs on Cloud Run infrastructure‚Äù14, and this fundamental architectural change leads to the differences in IAM configuration.\nUnderstanding these differences will help make the migration process smoother. In particular, knowing that Cloud Run-related permissions are needed is an important point to be aware of beforehand.\nI hope this article helps those undertaking similar migration work.\nReferences Compare Cloud Run functions | Cloud Run Documentation Access control with IAM | Cloud Run functions Documentation Function Identity | Cloud Run functions Documentation Terraform Tutorial | Cloud Run functions Documentation Google Cloud Functions is now Cloud Run functions | Google Cloud Blog¬†‚Ü©Ô∏é\nCloud Functions IAM Roles | Cloud Run functions Documentation¬†‚Ü©Ô∏é¬†‚Ü©Ô∏é\nAccess control with IAM | Cloud Run functions Documentation¬†‚Ü©Ô∏é\nSince 2nd generation Cloud Functions runs on Cloud Run, roles/run.invoker is required instead of roles/cloudfunctions.invoker¬†‚Ü©Ô∏é\nRoles and permissions for Cloud Run targets | Eventarc Standard¬†‚Ü©Ô∏é\nCompare Cloud Run functions | Cloud Run Documentation¬†‚Ü©Ô∏é\nFunction Identity | Cloud Functions Documentation¬†‚Ü©Ô∏é\nBest practices for using service accounts | IAM Documentation¬†‚Ü©Ô∏é\nUse service account impersonation | Authentication¬†‚Ü©Ô∏é\nCreate triggers from Pub/Sub events | Cloud Run Documentation¬†‚Ü©Ô∏é\nRoles and permissions for Cloud Run targets | Eventarc Standard¬†‚Ü©Ô∏é\nThis is the permission required for the Pub/Sub service agent to invoke Cloud Run functions¬†‚Ü©Ô∏é\nBuild process overview | Cloud Run functions Documentation¬†‚Ü©Ô∏é\nGoogle Cloud Functions is now Cloud Run functions | Google Cloud Blog¬†‚Ü©Ô∏é\n","wordCount":"1381","inLanguage":"en","datePublished":"2025-08-04T12:34:36Z","dateModified":"2025-08-04T12:34:36Z","author":{"@type":"Person","name":"BigBaBy"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://b1gb4by.github.io/posts/2025-08-04-terraform-custom-sa-cloud-functions/"},"publisher":{"@type":"Organization","name":"BigBaBy's Blog","logo":{"@type":"ImageObject","url":"https://b1gb4by.github.io/favicon.ico"}}}</script><script>!function(e){if(!window[e]){var t=window[e]=function(){var e=[].slice.call(arguments);return t.x?t.x.apply(0,e):t.q.push(e)};t.q=[],t.i=Date.now(),t.allow=function(){t.o="allow"},t.deny=function(){t.o="deny"}}}("krt")</script><script async src=https://cdn-edge.karte.io/f1bed561ac13b1955cc138d8bf589b07/edge.js></script></head><body><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://b1gb4by.github.io/ accesskey=h title="BigBaBy's Blog (Alt + H)">BigBaBy's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://b1gb4by.github.io/ja/ title=Japanese aria-label="üáØüáµ Japanese">üáØüáµ Japanese</a></li></ul></div></div><ul id=menu><li><a href=https://b1gb4by.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://b1gb4by.github.io/search/ title=Search><span>Search</span></a></li><li><a href=https://b1gb4by.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://b1gb4by.github.io/>Home</a>&nbsp;¬ª&nbsp;<a href=https://b1gb4by.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">IAM Configuration Changes and Custom Service Account Implementation When Migrating to Cloud Functions Gen2</h1><div class=post-description>This article shares the IAM configuration differences encountered when migrating Cloud Functions from 1st generation to 2nd generation, and the implementation methods for custom service accounts based on actual experience.</div><div class=post-meta><span title='2025-08-04 12:34:36 +0000 UTC'>August 4, 2025</span>&nbsp;¬∑&nbsp;7 min&nbsp;¬∑&nbsp;BigBaBy&nbsp;|&nbsp;Translations:<ul class=i18n_list><li><a href=https://b1gb4by.github.io/ja/posts/2025-08-04-terraform-custom-sa-cloud-functions/>üáØüáµ Japanese</a></li></ul></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#target-audience aria-label="Target Audience">Target Audience</a></li><li><a href=#initial-problem-encountered-changes-in-iam-resource-types aria-label="Initial Problem Encountered: Changes in IAM Resource Types">Initial Problem Encountered: Changes in IAM Resource Types</a><ul><li><a href=#1st-generation-configuration-traditional-method aria-label="1st Generation Configuration (Traditional Method)">1st Generation Configuration (Traditional Method)</a></li><li><a href=#2nd-generation-configuration-using-cloud-run-resources aria-label="2nd Generation Configuration (Using Cloud Run Resources)">2nd Generation Configuration (Using Cloud Run Resources)</a></li><li><a href=#differences-in-roles-between-1st-and-2nd-generation-this-is-important aria-label="Differences in Roles Between 1st and 2nd Generation (This is Important!)">Differences in Roles Between 1st and 2nd Generation (This is Important!)</a><ul><li><a href=#roles-required-for-deployment aria-label="Roles Required for Deployment">Roles Required for Deployment</a></li><li><a href=#roles-required-for-execution aria-label="Roles Required for Execution">Roles Required for Execution</a></li><li><a href=#service-account-changes aria-label="Service Account Changes">Service Account Changes</a></li></ul></li></ul></li><li><a href=#lessons-learned-from-custom-service-account-implementation aria-label="Lessons Learned from Custom Service Account Implementation">Lessons Learned from Custom Service Account Implementation</a><ul><li><a href=#issues-with-default-service-account aria-label="Issues with Default Service Account">Issues with Default Service Account</a></li><li><a href=#working-configuration aria-label="Working Configuration">Working Configuration</a></li><li><a href=#required-permission-settings aria-label="Required Permission Settings">Required Permission Settings</a></li></ul></li><li><a href=#special-cases-encountered-with-pubsub-triggers aria-label="Special Cases Encountered with Pub/Sub Triggers">Special Cases Encountered with Pub/Sub Triggers</a><ul><li><a href=#pubsub-service-account-format aria-label="Pub/Sub Service Account Format">Pub/Sub Service Account Format</a></li><li><a href=#why-pubsub-iam-configuration-became-complex aria-label="Why Pub/Sub IAM Configuration Became Complex">Why Pub/Sub IAM Configuration Became Complex</a></li><li><a href=#additional-requirements-when-deploying-via-cloud-build aria-label="Additional Requirements When Deploying via Cloud Build">Additional Requirements When Deploying via Cloud Build</a></li></ul></li><li><a href=#cloud-build-deployment-configuration aria-label="Cloud Build Deployment Configuration">Cloud Build Deployment Configuration</a></li><li><a href=#secret-manager-integration-additional-discovery aria-label="Secret Manager Integration (Additional Discovery)">Secret Manager Integration (Additional Discovery)</a><ul><li><a href=#benefits-of-using-secret-manager-instead-of-environment-variables aria-label="Benefits of Using Secret Manager Instead of Environment Variables">Benefits of Using Secret Manager Instead of Environment Variables</a></li></ul></li><li><a href=#lessons-learned-from-migration aria-label="Lessons Learned from Migration">Lessons Learned from Migration</a><ul><li><a href=#1-relationship-between-function-name-and-cloud-run-service-name aria-label="1. Relationship Between Function Name and Cloud Run Service Name">1. Relationship Between Function Name and Cloud Run Service Name</a></li><li><a href=#2-distinguishing-between-project_number-and-project_id aria-label="2. Distinguishing Between PROJECT_NUMBER and PROJECT_ID">2. Distinguishing Between PROJECT_NUMBER and PROJECT_ID</a></li><li><a href=#3-debugging-permission-errors aria-label="3. Debugging Permission Errors">3. Debugging Permission Errors</a></li></ul></li><li><a href=#summary aria-label=Summary>Summary</a><ul><li><a href=#references aria-label=References>References</a></li></ul></li></ul></div></details></div><div class=post-content><p>Recently, I had the opportunity to migrate existing Cloud Functions from 1st generation to 2nd generation.
During this process, I was surprised to find that the IAM configuration had changed more than expected, and the setup method for custom service accounts was also different from the 1st generation.</p><p>In this article, I&rsquo;ll share the technical insights gained from the actual migration work and the configurations required to get everything working properly.</p><h2 id=target-audience>Target Audience<a hidden class=anchor aria-hidden=true href=#target-audience>#</a></h2><ul><li>Those using Cloud Functions on Google Cloud</li><li>Those considering or implementing migration from 1st to 2nd generation</li><li>Those managing Cloud Functions with Terraform</li></ul><h2 id=initial-problem-encountered-changes-in-iam-resource-types>Initial Problem Encountered: Changes in IAM Resource Types<a hidden class=anchor aria-hidden=true href=#initial-problem-encountered-changes-in-iam-resource-types>#</a></h2><p>The first stumbling block in migrating to 2nd generation was that the Terraform IAM resources were completely different.</p><h3 id=1st-generation-configuration-traditional-method>1st Generation Configuration (Traditional Method)<a hidden class=anchor aria-hidden=true href=#1st-generation-configuration-traditional-method>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># This is how we wrote it in 1st generation
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;google_cloudfunctions_function_iam_member&#34; &#34;invoker&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  project</span>        <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>project_id</span>
</span></span><span class=line><span class=cl><span class=n>  region</span>         <span class=o>=</span> <span class=s2>&#34;asia-northeast1&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  cloud_function</span> <span class=o>=</span> <span class=s2>&#34;my-function&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  role</span>           <span class=o>=</span> <span class=s2>&#34;roles/cloudfunctions.invoker&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  member</span>         <span class=o>=</span> <span class=s2>&#34;serviceAccount:${var.service_account_email}&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><h3 id=2nd-generation-configuration-using-cloud-run-resources>2nd Generation Configuration (Using Cloud Run Resources)<a hidden class=anchor aria-hidden=true href=#2nd-generation-configuration-using-cloud-run-resources>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># In 2nd generation, we need to use Cloud Run resources
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;google_cloud_run_service_iam_member&#34; &#34;invoker&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  project</span>  <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>project_id</span>
</span></span><span class=line><span class=cl><span class=n>  location</span> <span class=o>=</span> <span class=s2>&#34;asia-northeast1&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  service</span>  <span class=o>=</span> <span class=s2>&#34;my-function&#34;</span><span class=c1>  # Function name becomes the service name
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  role</span>     <span class=o>=</span> <span class=s2>&#34;roles/run.invoker&#34;</span><span class=c1>  # The role has changed too!
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  member</span>   <span class=o>=</span> <span class=s2>&#34;serviceAccount:${var.service_account_email}&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>The reason for this change is that 2nd generation Cloud Functions now runs on a Cloud Run base<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.
In other words, it&rsquo;s internally treated as a Cloud Run service.</p><h3 id=differences-in-roles-between-1st-and-2nd-generation-this-is-important>Differences in Roles Between 1st and 2nd Generation (This is Important!)<a hidden class=anchor aria-hidden=true href=#differences-in-roles-between-1st-and-2nd-generation-this-is-important>#</a></h3><p>What I struggled with most during the migration was that the required roles had changed significantly.
After investigating the official Google Cloud documentation, the following differences became clear:</p><h4 id=roles-required-for-deployment>Roles Required for Deployment<a hidden class=anchor aria-hidden=true href=#roles-required-for-deployment>#</a></h4><p><strong>1st Generation</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;google_project_iam_member&#34; &#34;cloud_build_permissions_gen1&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  for_each</span> <span class=o>=</span> <span class=k>toset</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;roles/cloudfunctions.developer&#34;</span><span class=p>,</span><span class=c1>  # Cloud Functions developer
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s2>&#34;roles/iam.serviceAccountUser&#34;</span><span class=p>,</span><span class=c1>    # Service account usage permission
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>  project</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>project_id</span>
</span></span><span class=line><span class=cl><span class=n>  role</span>    <span class=o>=</span> <span class=k>each</span><span class=p>.</span><span class=k>value</span>
</span></span><span class=line><span class=cl><span class=n>  member</span>  <span class=o>=</span> <span class=s2>&#34;serviceAccount:${google_service_account.cloud_build.email}&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p><strong>2nd Generation</strong><sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;google_project_iam_member&#34; &#34;cloud_build_permissions_gen2&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  for_each</span> <span class=o>=</span> <span class=k>toset</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;roles/cloudfunctions.developer&#34;</span><span class=p>,</span><span class=c1>  # Cloud Functions developer (still needed)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s2>&#34;roles/run.admin&#34;</span><span class=p>,</span><span class=c1>                 # Cloud Run admin permission additionally required!
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s2>&#34;roles/iam.serviceAccountUser&#34;</span><span class=p>,</span><span class=c1>    # Service account usage permission
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s2>&#34;roles/eventarc.admin&#34;</span><span class=p>,</span><span class=c1>            # Required when using Pub/Sub triggers
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s2>&#34;roles/artifactregistry.reader&#34;</span><span class=p>,</span><span class=c1>   # Access to container images
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>  project</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>project_id</span>
</span></span><span class=line><span class=cl><span class=n>  role</span>    <span class=o>=</span> <span class=k>each</span><span class=p>.</span><span class=k>value</span>
</span></span><span class=line><span class=cl><span class=n>  member</span>  <span class=o>=</span> <span class=s2>&#34;serviceAccount:${google_service_account.cloud_build.email}&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><h4 id=roles-required-for-execution>Roles Required for Execution<a hidden class=anchor aria-hidden=true href=#roles-required-for-execution>#</a></h4><p><strong>1st Generation</strong>:</p><ul><li><code>roles/cloudfunctions.invoker</code> - To invoke the function</li></ul><p><strong>2nd Generation</strong><sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>:</p><ul><li><code>roles/run.invoker</code> - To invoke as a Cloud Run service<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup></li><li><code>roles/eventarc.eventReceiver</code> - When receiving Eventarc events other than Pub/Sub<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup></li></ul><p>If you migrate without understanding these differences, you&rsquo;ll end up in a situation where &ldquo;it should have permissions but it doesn&rsquo;t work.&rdquo;
In particular, the need for <code>roles/run.admin</code> was a point that&rsquo;s hard to notice without understanding the official documentation stating that &ldquo;Cloud Functions 2nd generation runs on Cloud Run infrastructure&rdquo;<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>.</p><h4 id=service-account-changes>Service Account Changes<a hidden class=anchor aria-hidden=true href=#service-account-changes>#</a></h4><p>Another important change is that the default runtime service account has changed<sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup>:</p><p><strong>1st Generation</strong>:</p><ul><li>Runtime: <code>PROJECT_ID@appspot.gserviceaccount.com</code> (App Engine default)</li></ul><p><strong>2nd Generation</strong>:</p><ul><li>Runtime: <code>PROJECT_NUMBER-compute@developer.gserviceaccount.com</code> (Compute Engine default)</li></ul><h2 id=lessons-learned-from-custom-service-account-implementation>Lessons Learned from Custom Service Account Implementation<a hidden class=anchor aria-hidden=true href=#lessons-learned-from-custom-service-account-implementation>#</a></h2><h3 id=issues-with-default-service-account>Issues with Default Service Account<a hidden class=anchor aria-hidden=true href=#issues-with-default-service-account>#</a></h3><p>By default, <code>PROJECT_NUMBER-compute@developer.gserviceaccount.com</code> is used, but this account has Editor permissions<sup id=fnref:8><a href=#fn:8 class=footnote-ref role=doc-noteref>8</a></sup>. From a security perspective, I decided to create a dedicated service account.</p><h3 id=working-configuration>Working Configuration<a hidden class=anchor aria-hidden=true href=#working-configuration>#</a></h3><p>Here&rsquo;s a generalized version of the configuration that worked properly in the actual project:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># Service account for Cloud Build (executes deployment)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;google_service_account&#34; &#34;cloud_build&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  account_id</span>   <span class=o>=</span> <span class=s2>&#34;cloud-build-deployer&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  project</span>      <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>project_id</span>
</span></span><span class=line><span class=cl><span class=n>  display_name</span> <span class=o>=</span> <span class=s2>&#34;Cloud Build Deployer&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  description</span>  <span class=o>=</span> <span class=s2>&#34;Service account for deploying Cloud Functions&#34;</span>
</span></span><span class=line><span class=cl>}<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Service account for Cloud Functions runtime
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;google_service_account&#34; &#34;cloud_functions&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  account_id</span>   <span class=o>=</span> <span class=s2>&#34;cf-my-function&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  project</span>      <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>project_id</span>
</span></span><span class=line><span class=cl><span class=n>  display_name</span> <span class=o>=</span> <span class=s2>&#34;Cloud Functions Runtime&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  description</span>  <span class=o>=</span> <span class=s2>&#34;Service account used at Cloud Functions runtime&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><h3 id=required-permission-settings>Required Permission Settings<a hidden class=anchor aria-hidden=true href=#required-permission-settings>#</a></h3><p>This is a crucial point. Since Cloud Build needs to use the Cloud Functions service account to execute deployment, granting <code>roles/iam.serviceAccountUser</code> permission was necessary<sup id=fnref:9><a href=#fn:9 class=footnote-ref role=doc-noteref>9</a></sup>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># Permission for Cloud Build to use Functions service account
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;google_service_account_iam_member&#34; &#34;cloud_build_act_as&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  service_account_id</span> <span class=o>=</span> <span class=k>google_service_account</span><span class=p>.</span><span class=k>cloud_functions</span><span class=p>.</span><span class=k>name</span>
</span></span><span class=line><span class=cl><span class=n>  role</span>               <span class=o>=</span> <span class=s2>&#34;roles/iam.serviceAccountUser&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  member</span>             <span class=o>=</span> <span class=s2>&#34;serviceAccount:${google_service_account.cloud_build.email}&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>This permission allows the Cloud Build service account to specify the Cloud Functions service account as the runtime identity for Cloud Functions. Without this configuration, you&rsquo;ll get permission errors during deployment.</p><h2 id=special-cases-encountered-with-pubsub-triggers>Special Cases Encountered with Pub/Sub Triggers<a hidden class=anchor aria-hidden=true href=#special-cases-encountered-with-pubsub-triggers>#</a></h2><h3 id=pubsub-service-account-format>Pub/Sub Service Account Format<a hidden class=anchor aria-hidden=true href=#pubsub-service-account-format>#</a></h3><p>When using Pub/Sub triggers, the following configuration was necessary:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;google_cloud_run_service_iam_member&#34; &#34;pubsub_invoker&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  project</span>  <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>project_id</span>
</span></span><span class=line><span class=cl><span class=n>  location</span> <span class=o>=</span> <span class=s2>&#34;asia-northeast1&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  service</span>  <span class=o>=</span> <span class=s2>&#34;my-function&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  role</span>     <span class=o>=</span> <span class=s2>&#34;roles/run.invoker&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  member</span>   <span class=o>=</span> <span class=s2>&#34;serviceAccount:service-${var.project_number}@gcp-sa-pubsub.iam.gserviceaccount.com&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Note that you must use <code>PROJECT_NUMBER</code>, not <code>PROJECT_ID</code>. I didn&rsquo;t notice this at first and wondered why I was getting permission errors.</p><h3 id=why-pubsub-iam-configuration-became-complex>Why Pub/Sub IAM Configuration Became Complex<a hidden class=anchor aria-hidden=true href=#why-pubsub-iam-configuration-became-complex>#</a></h3><p>Upon investigation, I found that in 2nd generation, Pub/Sub triggers now operate through Eventarc<sup id=fnref:10><a href=#fn:10 class=footnote-ref role=doc-noteref>10</a></sup>. According to the official documentation, <code>roles/eventarc.admin</code> permission is required when creating Eventarc triggers<sup id=fnref:11><a href=#fn:11 class=footnote-ref role=doc-noteref>11</a></sup>, and the trigger service account needs <code>roles/run.invoker</code> permission<sup id=fnref:12><a href=#fn:12 class=footnote-ref role=doc-noteref>12</a></sup>.</p><h3 id=additional-requirements-when-deploying-via-cloud-build>Additional Requirements When Deploying via Cloud Build<a hidden class=anchor aria-hidden=true href=#additional-requirements-when-deploying-via-cloud-build>#</a></h3><p>After checking the official documentation, I found that when deploying Gen2 functions via Cloud Build, the following additional permissions were also required<sup id=fnref:13><a href=#fn:13 class=footnote-ref role=doc-noteref>13</a></sup>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># Additional permissions required for Cloud Build service account
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;google_project_iam_member&#34; &#34;cloud_build_additional&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  for_each</span> <span class=o>=</span> <span class=k>toset</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;roles/storage.objectViewer&#34;</span><span class=p>,</span><span class=c1>     # Access to source code
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s2>&#34;roles/logging.logWriter&#34;</span><span class=p>,</span><span class=c1>        # Write build logs
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>  project</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>project_id</span>
</span></span><span class=line><span class=cl><span class=n>  role</span>    <span class=o>=</span> <span class=k>each</span><span class=p>.</span><span class=k>value</span>
</span></span><span class=line><span class=cl><span class=n>  member</span>  <span class=o>=</span> <span class=s2>&#34;serviceAccount:${google_service_account.cloud_build.email}&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><h2 id=cloud-build-deployment-configuration>Cloud Build Deployment Configuration<a hidden class=anchor aria-hidden=true href=#cloud-build-deployment-configuration>#</a></h2><p>The actual Cloud Build configuration used (generalized):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>deploy cloud function</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/google.com/cloudsdktool/cloud-sdk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;bash&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;-c&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        gcloud functions deploy my-function \
</span></span></span><span class=line><span class=cl><span class=sd>        --gen2 \
</span></span></span><span class=line><span class=cl><span class=sd>        --region=asia-northeast1 \
</span></span></span><span class=line><span class=cl><span class=sd>        --trigger-topic=my-topic \
</span></span></span><span class=line><span class=cl><span class=sd>        --runtime=nodejs20 \
</span></span></span><span class=line><span class=cl><span class=sd>        --entry-point=main \
</span></span></span><span class=line><span class=cl><span class=sd>        --service-account=${_CF_SERVICE_ACCOUNT}@${PROJECT_ID}.iam.gserviceaccount.com</span><span class=w>
</span></span></span></code></pre></div><p>The <code>--gen2</code> flag and <code>--service-account</code> option are important.</p><h2 id=secret-manager-integration-additional-discovery>Secret Manager Integration (Additional Discovery)<a hidden class=anchor aria-hidden=true href=#secret-manager-integration-additional-discovery>#</a></h2><h3 id=benefits-of-using-secret-manager-instead-of-environment-variables>Benefits of Using Secret Manager Instead of Environment Variables<a hidden class=anchor aria-hidden=true href=#benefits-of-using-secret-manager-instead-of-environment-variables>#</a></h3><p>During the migration work, I noticed that Secret Manager integration has become easier to use in 2nd generation<sup id=fnref1:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># Access permissions for Secret Manager
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;google_secret_manager_secret_iam_member&#34; &#34;function_secrets&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  for_each</span> <span class=o>=</span> <span class=k>toset</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;API_KEY&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;DATABASE_PASSWORD&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>  project</span>   <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>project_id</span>
</span></span><span class=line><span class=cl><span class=n>  secret_id</span> <span class=o>=</span> <span class=k>each</span><span class=p>.</span><span class=k>value</span>
</span></span><span class=line><span class=cl><span class=n>  role</span>      <span class=o>=</span> <span class=s2>&#34;roles/secretmanager.secretAccessor&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  member</span>    <span class=o>=</span> <span class=s2>&#34;serviceAccount:${google_service_account.cloud_functions.email}&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Deployment configuration:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>--<span class=l>set-secrets=&#34;API_KEY=API_KEY:latest&#34; \</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>--<span class=l>set-secrets=&#34;DB_PASSWORD=DATABASE_PASSWORD:latest&#34;</span><span class=w>
</span></span></span></code></pre></div><p>This eliminated the need to set sensitive information directly in environment variables.</p><h2 id=lessons-learned-from-migration>Lessons Learned from Migration<a hidden class=anchor aria-hidden=true href=#lessons-learned-from-migration>#</a></h2><h3 id=1-relationship-between-function-name-and-cloud-run-service-name>1. Relationship Between Function Name and Cloud Run Service Name<a hidden class=anchor aria-hidden=true href=#1-relationship-between-function-name-and-cloud-run-service-name>#</a></h3><p>In 2nd generation, the deployed function name becomes the Cloud Run service name as is. Without understanding this, you&rsquo;ll be confused when setting up IAM.</p><h3 id=2-distinguishing-between-project_number-and-project_id>2. Distinguishing Between PROJECT_NUMBER and PROJECT_ID<a hidden class=anchor aria-hidden=true href=#2-distinguishing-between-project_number-and-project_id>#</a></h3><p>Especially for Pub/Sub service accounts, you must use PROJECT_NUMBER:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Correct: service-123456789@gcp-sa-pubsub.iam.gserviceaccount.com
</span></span><span class=line><span class=cl>Wrong: service-my-project-id@gcp-sa-pubsub.iam.gserviceaccount.com
</span></span></code></pre></div><h3 id=3-debugging-permission-errors>3. Debugging Permission Errors<a hidden class=anchor aria-hidden=true href=#3-debugging-permission-errors>#</a></h3><p>When permission errors occur, checking the following in Cloud Logging makes it easier to identify the cause:</p><ul><li>Which service account is being used</li><li>Which roles are missing</li><li>Whether the resource name (especially Cloud Run service name) is correct</li></ul><h2 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h2><p>The migration to Cloud Functions 2nd generation involved major changes in the following areas:</p><ol><li><strong>IAM resource type change</strong>: From <code>google_cloudfunctions_function_iam_member</code> to <code>google_cloud_run_service_iam_member</code></li><li><strong>Role change</strong>: From <code>roles/cloudfunctions.invoker</code> to <code>roles/run.invoker</code></li><li><strong>Additional required roles</strong>: <code>roles/run.admin</code>, <code>roles/eventarc.admin</code>, <code>roles/artifactregistry.reader</code></li><li><strong>Pub/Sub trigger complexity</strong>: Additional configuration due to operating through Eventarc</li><li><strong>Default service account change</strong>: From App Engine default to Compute Engine default</li><li><strong>Custom service account permissions</strong>: Need for <code>roles/iam.serviceAccountUser</code></li></ol><p>These changes stem from 2nd generation being based on Cloud Run.
The official documentation clearly states that &ldquo;Cloud Functions 2nd generation runs on Cloud Run infrastructure&rdquo;<sup id=fnref:14><a href=#fn:14 class=footnote-ref role=doc-noteref>14</a></sup>, and this fundamental architectural change leads to the differences in IAM configuration.</p><p>Understanding these differences will help make the migration process smoother.
In particular, knowing that Cloud Run-related permissions are needed is an important point to be aware of beforehand.</p><p>I hope this article helps those undertaking similar migration work.</p><hr><h3 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h3><ul><li><a href=https://cloud.google.com/run/docs/functions/comparison>Compare Cloud Run functions | Cloud Run Documentation</a></li><li><a href=https://cloud.google.com/functions/docs/concepts/iam>Access control with IAM | Cloud Run functions Documentation</a></li><li><a href=https://cloud.google.com/functions/docs/securing/function-identity>Function Identity | Cloud Run functions Documentation</a></li><li><a href=https://cloud.google.com/functions/docs/tutorials/terraform>Terraform Tutorial | Cloud Run functions Documentation</a></li></ul><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://cloud.google.com/blog/products/serverless/google-cloud-functions-is-now-cloud-run-functions>Google Cloud Functions is now Cloud Run functions | Google Cloud Blog</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://cloud.google.com/functions/docs/reference/iam/roles>Cloud Functions IAM Roles | Cloud Run functions Documentation</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://cloud.google.com/functions/docs/concepts/iam>Access control with IAM | Cloud Run functions Documentation</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>Since 2nd generation Cloud Functions runs on Cloud Run, <code>roles/run.invoker</code> is required instead of <code>roles/cloudfunctions.invoker</code>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p><a href=https://cloud.google.com/eventarc/docs/roles-permissions>Roles and permissions for Cloud Run targets | Eventarc Standard</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p><a href=https://cloud.google.com/run/docs/functions/comparison>Compare Cloud Run functions | Cloud Run Documentation</a>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:7><p><a href=https://cloud.google.com/functions/docs/securing/function-identity>Function Identity | Cloud Functions Documentation</a>&#160;<a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:8><p><a href=https://cloud.google.com/iam/docs/best-practices-service-accounts>Best practices for using service accounts | IAM Documentation</a>&#160;<a href=#fnref:8 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:9><p><a href=https://cloud.google.com/docs/authentication/use-service-account-impersonation>Use service account impersonation | Authentication</a>&#160;<a href=#fnref:9 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:10><p><a href=https://cloud.google.com/run/docs/triggering/pubsub-triggers>Create triggers from Pub/Sub events | Cloud Run Documentation</a>&#160;<a href=#fnref:10 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:11><p><a href=https://cloud.google.com/eventarc/docs/roles-permissions>Roles and permissions for Cloud Run targets | Eventarc Standard</a>&#160;<a href=#fnref:11 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:12><p>This is the permission required for the Pub/Sub service agent to invoke Cloud Run functions&#160;<a href=#fnref:12 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:13><p><a href=https://cloud.google.com/functions/docs/building>Build process overview | Cloud Run functions Documentation</a>&#160;<a href=#fnref:13 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:14><p><a href=https://cloud.google.com/blog/products/serverless/google-cloud-functions-is-now-cloud-run-functions>Google Cloud Functions is now Cloud Run functions | Google Cloud Blog</a>&#160;<a href=#fnref:14 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://b1gb4by.github.io/tags/google-cloud/>Google Cloud</a></li><li><a href=https://b1gb4by.github.io/tags/cloud-functions/>Cloud Functions</a></li><li><a href=https://b1gb4by.github.io/tags/cloud-run/>Cloud Run</a></li><li><a href=https://b1gb4by.github.io/tags/iam/>IAM</a></li><li><a href=https://b1gb4by.github.io/tags/terraform/>Terraform</a></li><li><a href=https://b1gb4by.github.io/tags/service-account/>Service Account</a></li></ul><nav class=paginav><a class=next href=https://b1gb4by.github.io/posts/2021-09-28-device-configs/><span class=title>Next ¬ª</span><br><span>About the device used</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share IAM Configuration Changes and Custom Service Account Implementation When Migrating to Cloud Functions Gen2 on x" href="https://x.com/intent/tweet/?text=IAM%20Configuration%20Changes%20and%20Custom%20Service%20Account%20Implementation%20When%20Migrating%20to%20Cloud%20Functions%20Gen2&amp;url=https%3a%2f%2fb1gb4by.github.io%2fposts%2f2025-08-04-terraform-custom-sa-cloud-functions%2f&amp;hashtags=GoogleCloud%2cCloudFunctions%2cCloudRun%2cIAM%2cTerraform%2cServiceAccount"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share IAM Configuration Changes and Custom Service Account Implementation When Migrating to Cloud Functions Gen2 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fb1gb4by.github.io%2fposts%2f2025-08-04-terraform-custom-sa-cloud-functions%2f&amp;title=IAM%20Configuration%20Changes%20and%20Custom%20Service%20Account%20Implementation%20When%20Migrating%20to%20Cloud%20Functions%20Gen2&amp;summary=IAM%20Configuration%20Changes%20and%20Custom%20Service%20Account%20Implementation%20When%20Migrating%20to%20Cloud%20Functions%20Gen2&amp;source=https%3a%2f%2fb1gb4by.github.io%2fposts%2f2025-08-04-terraform-custom-sa-cloud-functions%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share IAM Configuration Changes and Custom Service Account Implementation When Migrating to Cloud Functions Gen2 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fb1gb4by.github.io%2fposts%2f2025-08-04-terraform-custom-sa-cloud-functions%2f&title=IAM%20Configuration%20Changes%20and%20Custom%20Service%20Account%20Implementation%20When%20Migrating%20to%20Cloud%20Functions%20Gen2"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share IAM Configuration Changes and Custom Service Account Implementation When Migrating to Cloud Functions Gen2 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fb1gb4by.github.io%2fposts%2f2025-08-04-terraform-custom-sa-cloud-functions%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share IAM Configuration Changes and Custom Service Account Implementation When Migrating to Cloud Functions Gen2 on whatsapp" href="https://api.whatsapp.com/send?text=IAM%20Configuration%20Changes%20and%20Custom%20Service%20Account%20Implementation%20When%20Migrating%20to%20Cloud%20Functions%20Gen2%20-%20https%3a%2f%2fb1gb4by.github.io%2fposts%2f2025-08-04-terraform-custom-sa-cloud-functions%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share IAM Configuration Changes and Custom Service Account Implementation When Migrating to Cloud Functions Gen2 on telegram" href="https://telegram.me/share/url?text=IAM%20Configuration%20Changes%20and%20Custom%20Service%20Account%20Implementation%20When%20Migrating%20to%20Cloud%20Functions%20Gen2&amp;url=https%3a%2f%2fb1gb4by.github.io%2fposts%2f2025-08-04-terraform-custom-sa-cloud-functions%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share IAM Configuration Changes and Custom Service Account Implementation When Migrating to Cloud Functions Gen2 on ycombinator" href="https://news.ycombinator.com/submitlink?t=IAM%20Configuration%20Changes%20and%20Custom%20Service%20Account%20Implementation%20When%20Migrating%20to%20Cloud%20Functions%20Gen2&u=https%3a%2f%2fb1gb4by.github.io%2fposts%2f2025-08-04-terraform-custom-sa-cloud-functions%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>¬© <a href=https://b1gb4by.github.io/>BigBaBy</a></span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>