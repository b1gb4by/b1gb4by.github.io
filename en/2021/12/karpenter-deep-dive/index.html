<!doctype html><html lang=en>
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BRRNK5J7PW"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-BRRNK5J7PW')</script>
<meta name=google-site-verification content="MI9tWDvB5U3u_StKcJVdMhElMqisSGg7sJaKL0XmdMg">
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Karpenter Deep Dive | </title><meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://t4i5uKE.github.io/en/2021/12/karpenter-deep-dive/featured-image.webp">
<meta name=twitter:title content="Karpenter Deep Dive">
<meta name=twitter:description content="Let's take a deep dive into Karpenter."><meta name=twitter:creator content="@m0rer0"><meta name=Description content="Let's take a deep dive into Karpenter."><meta property="og:title" content="Karpenter Deep Dive">
<meta property="og:description" content="Let's take a deep dive into Karpenter.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://t4i5uKE.github.io/en/2021/12/karpenter-deep-dive/"><meta property="og:image" content="https://t4i5uKE.github.io/en/2021/12/karpenter-deep-dive/featured-image.webp"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-12-27T17:25:25+09:00">
<meta property="article:modified_time" content="2022-01-21T03:04:10+09:00">
<meta name=application-name content="morero's blog">
<meta name=apple-mobile-web-app-title content="morero's blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=favicon.svg type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://t4i5uKE.github.io/en/2021/12/karpenter-deep-dive/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/lib/prismjs/prism.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Karpenter Deep Dive","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/t4i5uKE.github.io\/en\/2021\/12\/karpenter-deep-dive\/"},"image":[{"@type":"ImageObject","url":"https:\/\/t4i5uKE.github.io\/en\/2021\/12\/karpenter-deep-dive\/featured-image.webp","width":1280,"height":640}],"genre":"posts","keywords":"AWS, EKS, Kubernetes, Auto Scaling","wordCount":1723,"url":"https:\/\/t4i5uKE.github.io\/en\/2021\/12\/karpenter-deep-dive\/","datePublished":"2021-12-27T17:25:25+09:00","dateModified":"2022-01-21T03:04:10+09:00","description":"Let's take a deep dive into Karpenter."}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https:\/\/t4i5uKE.github.io\/"},{"@type":"ListItem","position":2,"name":"Kubernetes","item":"https://t4i5uKE.github.io/en/categories/kubernetes/"},{"@type":"ListItem","position":3,"name":"Karpenter Deep Dive"}]}</script></head>
<body data-header-desktop=fixed data-header-mobile=auto><script>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header>
<div class="desktop header" id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/en/ title="morero's blog" class="header-logo logo-svg">morero's blog</a>
</div>
<div class=menu>
<nav>
<h2 class=display-hidden>Основная навигация</h2>
<ul class=menu-inner><li>
<a class=menu-item href=/en/posts/> Posts </a>
</li><li>
<a class=menu-item href=/en/tags/> Tags </a>
</li><li>
<a class=menu-item href=/en/categories/> Categories </a>
</li><li>
<a class=menu-item href=/en/resume/> Resume </a>
</li><li>
<a class=menu-item href=/en/about/> WHORU? </a>
</li></ul>
</nav><span class="menu-item delimiter"></span><span onclick="void 0" class="menu-item language" title="Select Language">English<select class=language-select id=language-select-desktop onchange="location=this.value"><option value=/en/2021/12/karpenter-deep-dive/ selected>English</option><option value=/2021/12/karpenter-deep-dive/>Japanese</option></select>
</span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search>
<span class="svg-icon icon-search"></span>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear>
<span class="svg-icon icon-cancel"></span>
</a>
<span class="search-button search-loading" id=search-loading-desktop>
<span class="svg-icon icon-loading"></span>
</span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<span class="svg-icon icon-moon"></span>
</a>
</div>
</div>
</div><div class="mobile header" id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/en/ title="morero's blog" class=header-logo>morero's blog</a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><div class=search-wrapper>
<div class="search mobile" id=search-mobile>
<input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search>
<span class="svg-icon icon-search"></span>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear>
<span class="svg-icon icon-cancel"></span>
</a>
<span class="search-button search-loading" id=search-loading-mobile>
<span class="svg-icon icon-loading"></span>
</span>
</div>
<a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>
Cancel
</a>
</div><nav>
<h2 class=display-hidden>Основная навигация</h2>
<ul><li>
<a class=menu-item href=/en/posts/ title>Posts</a>
</li><li>
<a class=menu-item href=/en/tags/ title>Tags</a>
</li><li>
<a class=menu-item href=/en/categories/ title>Categories</a>
</li><li>
<a class=menu-item href=/en/resume/ title>Resume</a>
</li><li>
<a class=menu-item href=/en/about/ title>WHORU?</a>
</li></ul>
</nav>
<a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<span class="svg-icon icon-moon"></span>
</a><span onclick="void 0" class=menu-item title="Select Language">English<select class=language-select onchange="location=this.value"><option value=/en/2021/12/karpenter-deep-dive/ selected>English</option><option value=/2021/12/karpenter-deep-dive/>Japanese</option></select>
</span></div>
</div>
</div><div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div></header><main class=main>
<div class="container content-article page-toc theme-classic"><div class=toc id=toc-auto>
<div class=toc-title>Contents</div>
<div class=toc-content id=toc-content-auto></div>
</div>
<article>
<header class=header-post>
<div class=post-title>
<div class=post-all-meta>
<nav class=breadcrumbs>
<ol>
<li><a href=/en/>Home </a></li><li><a href=/en/categories/kubernetes/>Kubernetes </a></li><li>Karpenter Deep Dive</li>
</ol>
</nav>
<h1 class="single-title flipInX">Karpenter Deep Dive</h1><div class="post-meta summary-post-meta"><span class="post-category meta-item">
<a href=/en/categories/kubernetes/><span class="svg-icon icon-folder"></span>Kubernetes</a>
</span><span class="post-meta-date meta-item">
<span class="svg-icon icon-clock"></span><time class=timeago datetime=2021-12-27>2021-12-27</time>
</span><span class="post-meta-words meta-item">
<span class="svg-icon icon-pencil"></span>1723 words
</span>
<span class="post-meta-reading meta-item">
<span class="svg-icon icon-stopwatch"></span>9 minutes
</span>
</div>
</div>
</div>
</header>
<div class="article-post toc-start">
<div class="content-block content-block-first content-block-position">
<div class="post single"><div class=image-theme-classic>
<img src=https://t4i5uKE.github.io/en/2021/12/karpenter-deep-dive/featured-image.webp style=width:100%>
</div><div class="details toc" id=toc-static data-kept>
<div class="details-summary toc-title">
<span>Contents</span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents>
<ul>
<li><a href=#introduction>Introduction.</a></li>
<li><a href=#what-is-karpenter>What is Karpenter?</a></li>
<li><a href=#autoscale-in-kubernetes>Autoscale in Kubernetes</a>
<ul>
<li>
<ul>
<li><a href=#horizontal-pod-autoscaler>Horizontal Pod Autoscaler</a></li>
<li><a href=#vertical-pod-autoscaler>Vertical Pod Autoscaler</a></li>
</ul>
</li>
<li><a href=#node>Node</a>
<ul>
<li><a href=#cluster-autoscaler>Cluster Autoscaler</a></li>
</ul>
</li>
</ul>
</li>
<li><a href=#how-to-install>How to install</a></li>
<li><a href=#configure-the-provisioner>Configure the provisioner</a>
<ul>
<li><a href=#unschedulable-pods>Unschedulable pods</a></li>
<li><a href=#provisioner-cr>Provisioner CR</a></li>
</ul>
</li>
<li><a href=#deprovisioning-node>Deprovisioning Node</a>
<ul>
<li><a href=#finalizer>Finalizer</a></li>
<li><a href=#node-expiry>Node Expiry</a></li>
<li><a href=#empty-nodes>Empty Nodes</a></li>
</ul>
</li>
<li><a href=#upgrade-node>Upgrade Node</a></li>
<li><a href=#constraints>Constraints</a></li>
<li><a href=#scheduling>Scheduling</a></li>
<li><a href=#cloud-provider>Cloud provider</a></li>
<li><a href=#difference-from-cluster-autoscaler>Difference from Cluster Autoscaler</a>
<ul>
<li><a href=#designed-to-take-advantage-of-the-flexibility-of-the-cloud>Designed to take advantage of the flexibility of the cloud</a></li>
<li><a href=#groupless-node-provisioning>Groupless Node Provisioning</a></li>
<li><a href=#scheduling-implementation>Scheduling Implementation</a></li>
</ul>
</li>
<li><a href=#thoughts>Thoughts</a></li>
</ul>
</nav></div>
</div><div style="margin:20px 0">
<span class=post-update>
<span class=s>Updated on 2022-01-21</span>
</span>
</div><p>Recently, Karpenter graduated from AWS re:Invent with autoscaling of Nodes in Kubernetes clusters.</p>
<p>In this article, we&rsquo;ll take a deeper look at it.</p>
<h2 id=introduction class=headerLink><a href=#introduction class=header-mark></a>Introduction.</h2><p>This is the 18th day of the [Kubernetes Advent Calendar 2021](&lt;(<a href=https://qiita.com/advent-calendar/2021/kubernetes%29%29 target=_blank rel="noopener noreffer">https://qiita.com/advent-calendar/2021/kubernetes))</a>.</p>
<h2 id=what-is-karpenter class=headerLink><a href=#what-is-karpenter class=header-mark></a>What is Karpenter?</h2><p>Officially described as &ldquo;Just-in-time Nodes for Any Kubernetes Cluster&rdquo;, Karpenter provides the ability to instantly provision new Nodes for unscheduled Pods. The goal is to improve the efficiency and cost of running workloads on Kubernetes clusters.</p>
<p>Karpenter works as follows.</p>
<ul>
<li>Monitor Pods that the Kubernetes scheduler has marked as unschedulable</li>
<li>Evaluate the following scheduling constraints as requested by the Pod
<ul>
<li>Resource Request</li>
<li>Node Selector</li>
<li>Affinity</li>
<li>Tolerant</li>
<li>Topology spreading constraints</li>
</ul>
</li>
<li>Provisioning a Node to meet Pod requirements</li>
<li>Scheduling a Pod to run on a new Node</li>
<li>Deleting a Node when it is no longer needed</li>
</ul>
<div class="details admonition info open">
<div class="details-summary admonition-title"><i class="icon admonition-icon icon-info"></i>How to use Karpenter<i class="details-icon admonition-icon admonition-icon-arrow-right"></i></div>
<div class=details-content>
<div class=admonition-content>Karpenter will only support AWS as of December 2021.</div>
</div>
</div>
<h2 id=autoscale-in-kubernetes class=headerLink><a href=#autoscale-in-kubernetes class=header-mark></a>Autoscale in Kubernetes</h2><p>There are two ways to scale the Pod.</p>
<h4 id=horizontal-pod-autoscaler class=headerLink><a href=#horizontal-pod-autoscaler class=header-mark></a>Horizontal Pod Autoscaler</h4><p>Horizontal pod scaling is a method of scaling to improve processing performance by increasing the number of pods. User-defined metrics such as CPU, memory, etc. can also be used to make decisions.</p>
<p>The number of pods is calculated by the following formula.</p>
<p><code>Number of replicas desired = ceil[&lt;current number of pods> * (&lt;current index value / &lt;target index value>)]</code>.</p>
<h4 id=vertical-pod-autoscaler class=headerLink><a href=#vertical-pod-autoscaler class=header-mark></a>Vertical Pod Autoscaler</h4><p>This is a method of scaling that improves processing performance by increasing the resources available to the pod. In this case, the CPU and memory are used as criteria. It is more like optimizing the resource utilization.</p>
<h3 id=node class=headerLink><a href=#node class=header-mark></a>Node</h3><h4 id=cluster-autoscaler class=headerLink><a href=#cluster-autoscaler class=header-mark></a>Cluster Autoscaler</h4><p>It is a method of scaling to improve processing performance by increasing the number of worker Nodes. It can also be used in conjunction with horizontal scaling of Pods.</p>
<h2 id=how-to-install class=headerLink><a href=#how-to-install class=header-mark></a>How to install</h2><p>Karpenter will be installed on the cluster with Helm Chart.
Karpenter also requires IAM Roles for Service Accounts (IRSA).</p>
<p>Currently, the utilities required to use Karpenter are as follows</p>
<ul>
<li><a href=https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html target=_blank rel="noopener noreffer">AWS CLI</a></li>
<li><code>kubectl</code>
<ul>
<li><a href=https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/ target=_blank rel="noopener noreffer">the Kubernetes CLI</a></li>
</ul>
</li>
<li><code>eksctl</code>
<ul>
<li><a href=https://docs.aws.amazon.com/eks/latest/userguide/eksctl.html target=_blank rel="noopener noreffer">the CLI for AWS EKS</a></li>
</ul>
</li>
<li><code>helm</code>
<ul>
<li><a href=https://karpenter.sh/docs/getting-started/#install target=_blank rel="noopener noreffer">the package manager for Kubernetes</a></li>
</ul>
</li>
</ul>
<p>To learn how to install Karpenter on AWS, please refer to the official document &ldquo;<a href=https://karpenter.sh/docs/getting-started/#install target=_blank rel="noopener noreffer">Getting Started with Karpenter on AWS</a>&rdquo;.</p>
<p>Karpenter&rsquo;s Helm Chart can be found <a href=https://github.com/aws/karpenter/tree/main/charts/karpenter target=_blank rel="noopener noreffer">here</a>.</p>
<div class="details admonition note">
<div class="details-summary admonition-title"><i class="icon admonition-icon icon-note"></i>Installation with Terraform<i class="details-icon admonition-icon admonition-icon-arrow-right"></i></div>
<div class=details-content>
<div class=admonition-content>Kapenter also provides an installation method using <a href=https://learn.hashicorp.com/tutorials/terraform/install-cli target=_blank rel="noopener noreffer">Terraform</a>. See <a href=https://karpenter.sh/docs/getting-started-with-terraform/ target=_blank rel="noopener noreffer">here</a> for details.</div>
</div>
</div>
<p>An overview diagram is shown in the figure below.</p>
<p>
<img loading=lazy decoding=async class=render-image src=./karpenter-overview.webp alt="Karpenter Overview" title=karpenter-overview.webp></p>
<h2 id=configure-the-provisioner class=headerLink><a href=#configure-the-provisioner class=header-mark></a>Configure the provisioner</h2><p>Karpenter&rsquo;s job is to add Nodes that handle non-schedulable Pods, schedule Pods on those Nodes, and remove the Nodes when they are no longer needed.</p>
<p>To configure Karpenter, create a provisioner that defines how Karpenter will manage non-schedulable Pods and timed Nodes.</p>
<p>The following is what you need to know about Karpenter provisioners.</p>
<h3 id=unschedulable-pods class=headerLink><a href=#unschedulable-pods class=header-mark></a>Unschedulable pods</h3><p>Karpenter will only attempt to provision Pods with the status condition <code>Unschedulable=True</code>. This will be set when the kube-scheduler fails to schedule a Pod to an existing capacity.</p>
<h3 id=provisioner-cr class=headerLink><a href=#provisioner-cr class=header-mark></a>Provisioner CR</h3><p>Karpenter defines a custom resource called <code>Provisioner</code> to specify the provisioning configuration.</p>
<p>Each provisioner manages a separate set of Nodes, but a Pod can be scheduled to any provisioner that supports its scheduling constraints.</p>
<p>A provisioner contains constraints that affect the Nodes that can be provisioned and the attributes of the Nodes (such as timers for removing Nodes).</p>
<p>The following are the resources of the provisioner.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>karpenter.sh/v1alpha5</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Provisioner</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>ttlSecondsUntilExpired</span><span class=p>:</span><span class=w> </span><span class=m>2592000</span><span class=w>
</span><span class=w>  </span><span class=nt>ttlSecondsAfterEmpty</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span><span class=w>  </span><span class=nt>taints</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>example.com/special-taint</span><span class=w>
</span><span class=w>      </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoSchedule</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>billing-team</span><span class=p>:</span><span class=w> </span><span class=l>my-team</span><span class=w>
</span><span class=w>  </span><span class=nt>requirements</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;node.kubernetes.io/instance-type&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span><span class=w>      </span><span class=nt>values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;m5.large&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;m5.2xlarge&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;topology.kubernetes.io/zone&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span><span class=w>      </span><span class=nt>values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;us-west-2a&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;us-west-2b&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;kubernetes.io/arch&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span><span class=w>      </span><span class=nt>values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;arm64&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;amd64&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;karpenter.sh/capacity-type&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span><span class=w>      </span><span class=nt>values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;spot&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;on-demand&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>  </span><span class=nt>provider</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>The <code>spec.ttlSecondsUntilExpired</code> is the number of seconds the controller will wait before exiting the Node, measured from the time the Node is created. This is useful to eventually implement features like consistent Node upgrades, memory leak protection, and destructive testing. If this field is not set, termination due to expiration will be disabled.</p>
<p>The <code>spec.ttlSecondsAfterEmpty</code> is the number of seconds the controller will wait between the time it detects that a Node is empty and the time it tries to remove the Node. A Node is considered empty if there are no Pods scheduled for that Node, except for the daemonset.</p>
<p>The <code>spec.requirements</code> constrains the parameters of the provisioned Node. It can be combined with <code>nodeAffinity</code> and <code>nodeSelector</code>. The <code>{ In, NotIn }</code> operator is supported to include or exclude values.</p>
<h2 id=deprovisioning-node class=headerLink><a href=#deprovisioning-node class=header-mark></a>Deprovisioning Node</h2><p>Karpenter deletes the nodes that are no longer needed as follows.</p>
<h3 id=finalizer class=headerLink><a href=#finalizer class=header-mark></a>Finalizer</h3><p>Karpenter will place a finalizer bit in each Node it creates.</p>
<p>When a request to delete these Nodes comes in (such as a TTL or manual Node deletion via kubectl), Karpenter codes the Node, ejects all Pods, terminates the EC2 instance, and deletes the Node object.</p>
<p>Karpenter handles all the cleanup work required to properly delete the Node.</p>
<h3 id=node-expiry class=headerLink><a href=#node-expiry class=header-mark></a>Node Expiry</h3><p>When a Node reaches its expiration value (<code>ttlSecondsUntilExpired</code>), it will be ejected and removed from the Pod (even if it is still running a workload).</p>
<h3 id=empty-nodes class=headerLink><a href=#empty-nodes class=header-mark></a>Empty Nodes</h3><p>When the last workload Pod running on a Karpenter-managed Node runs out, that Node will be given an <code>emptiness</code> timestamp. When its &ldquo;Node is empty&rdquo; expiration date (<code>ttlSecondsAfterEmpty</code>) is reached, finalization is triggered.</p>
<div class="details admonition info open">
<div class="details-summary admonition-title"><i class="icon admonition-icon icon-info"></i>About how to remove Node<i class="details-icon admonition-icon admonition-icon-arrow-right"></i></div>
<div class=details-content>
<div class=admonition-content>For more information on how Karpenter deletes Nodes, see <a href=https://karpenter.sh/docs/tasks/deprov-nodes/ target=_blank rel="noopener noreffer">Details</a> on Node deprovisioning.</div>
</div>
</div>
<h2 id=upgrade-node class=headerLink><a href=#upgrade-node class=header-mark></a>Upgrade Node</h2><p>An easy way to upgrade a Node is to set <code>ttlSecondsUntilExpired</code>, which will expire after a set period of time and be replaced by a newer Node.</p>
<h2 id=constraints class=headerLink><a href=#constraints class=header-mark></a>Constraints</h2><p>Because there are no constraints defined by the provisioner or requested by the Pod being deployed, Karpenter is selected from the entire set of features available from the cloud provider. Nodes can be created using any instance type and run in any zone.</p>
<h2 id=scheduling class=headerLink><a href=#scheduling class=header-mark></a>Scheduling</h2><p>Karpenter schedules Pods that are marked as <code>unschedulable</code> by the Kubernetes scheduler. After resolving scheduling constraints and startup capacity, it creates a Node and binds the Pod. This stateless approach will help you avoid race conditions and improve performance. If there is a problem with a launched Node, Kubernetes will automatically migrate the Pod to a new Node. When Karpenter launches a Node, it will also allow Kubernetes' scheduler to schedule on it.</p>
<h2 id=cloud-provider class=headerLink><a href=#cloud-provider class=header-mark></a>Cloud provider</h2><p>Karpenter makes a request to the relevant cloud provider for provisioning a new Node. The first supported cloud provider is AWS, but Karpenter is designed to work with other cloud providers as well. While using the well-known labels of Kubernetes, the provisioner can set a number of values specific to the cloud provider.</p>
<p>If you are developing your own provider, you can create it in the repository under <code>pkg/cloudprovider/</code>. The directory structure is as follows. The <code>fake</code> directory is provided as an example for reference.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>.
├── aws
│   ├── apis
│   │   └── v1alpha1
│   └── fake
├── fake
├── metrics
└── registry
</code></pre></td></tr></table>
</div>
</div><p>First, you need to create the following files for each cloud provider under <code>pkg/cloudprovider/registry</code> to register them.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=c1>// +build &lt;YOUR_PROVIDER_NAME&gt;
</span><span class=c1></span><span class=kn>import</span> <span class=p>(</span>
<span class=s>&#34;github.com/aws/karpenter/pkg/cloudprovider/&lt;YOUR_PROVIDER_NAME&gt;&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>NewCloudProvider</span><span class=p>()</span> <span class=nx>cloudprovider</span><span class=p>.</span><span class=nx>CloudProvider</span> <span class=p>{</span>
<span class=k>return</span> <span class=p>&lt;</span><span class=nx>YOUR_PROVIDER_NAME</span><span class=p>&gt;.</span><span class=nf>NewCloudProvider</span><span class=p>()</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>You can also create one for each cloud provider under <code>pkg/cloudprovider</code> for your environment. If you check the <code>fake</code> directory, you will find the following files. You can add other necessary information according to your environment.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>.
├── cloudprovider.go
└── instancetype.go
</code></pre></td></tr></table>
</div>
</div><h2 id=difference-from-cluster-autoscaler class=headerLink><a href=#difference-from-cluster-autoscaler class=header-mark></a>Difference from Cluster Autoscaler</h2><p>Like Karpenter, the Kubernetes Cluster Autoscaler is designed to add Nodes when a request comes in to run a Pod that cannot be handled by the current capacity.
Cluster Autoscaler is part of the Kubernetes project and is implemented by most of the major Kubernetes cloud providers. By rethinking provisioning, Karpenter provides the following improvements.</p>
<h3 id=designed-to-take-advantage-of-the-flexibility-of-the-cloud class=headerLink><a href=#designed-to-take-advantage-of-the-flexibility-of-the-cloud class=header-mark></a>Designed to take advantage of the flexibility of the cloud</h3><p>Karpenter has the ability to efficiently handle any type of instance available in AWS. Cluster Autoscaler was not originally built with the flexibility to support hundreds of instance types, zones, and purchase options.</p>
<h3 id=groupless-node-provisioning class=headerLink><a href=#groupless-node-provisioning class=header-mark></a>Groupless Node Provisioning</h3><p>Karpenter manages each instance directly, without orchestration mechanisms such as Node groups. This allows you to retry in milliseconds instead of minutes if capacity is not available. It also allows you to take advantage of a variety of instance types, availability zones, and purchasing options without having to create hundreds of Node groups.</p>
<h3 id=scheduling-implementation class=headerLink><a href=#scheduling-implementation class=header-mark></a>Scheduling Implementation</h3><p>Cluster Autoscaler does not bind a Pod to the Node it creates. Instead, it relies on the <code>kube-scheduler</code> to make the same scheduling decision after the Node comes online. The Node started by Karpenter is bound to its Pod immediately. kubelet<code> does not need to wait for the scheduler or Node to be ready. kubelet</code> does not need to wait for the scheduler or Node to be ready, it can start preparing the container runtime immediately, including pre-pulling images. This can reduce the Node startup latency by a few seconds.</p>
<h2 id=thoughts class=headerLink><a href=#thoughts class=header-mark></a>Thoughts</h2><p>In this article, I&rsquo;ve tried to dig a little deeper into Karpenter.</p>
<p>Personally, I think it&rsquo;s the same as GKE Autopilot&rsquo;s dynamic Node provisioning process. I think Karpenter is an OSS version of that tool. Like GKE Autopilot, Karpenter observes the specification of non-schedulable pods, computes aggregate resource requests, and sends the requests to an underlying compute service (such as Amazon EC2) that has the capacity required to run all the pods.</p>
<p>Karpenter also allows you to define custom resources and specify the provisioning configuration for the following Nodes. We found the flexibility to change the configuration to be a significant advantage.</p>
<ul>
<li>Instance size/type, topology (zone, etc.)</li>
<li>Architecture (arm64, amd64, etc.)</li>
<li>Lifecycle type (spot, on-demand, pre-emptive, etc.)</li>
</ul>
<p>On the other hand, Karpenter can also deprovision a Node when it is no longer needed. This can be determined by setting the Node&rsquo;s expiration date (<code>ttlSecondsUntilExpired</code>) or when the last workload running on a Karpenter provisioned Node has finished (<code>ttlSecondsAfterEmpty</code>). Either of these two events triggers a finalization that codes the Node, ejects the Pod, terminates the underlying compute resource, and deletes the Node object. This deprovisioning feature can also be used to keep Node up-to-date with the latest AMI.</p>
<p>With Karpenter, I believe you can offload Node provisioning, autoscaling and upgrading and focus on running your application. Karpenter works with all kinds of Kubernetes applications, but I think it performs especially well in use cases where large amounts of diverse compute resources need to be provisioned and de-provisioned quickly. (Training machine learning models, running simulations, batch jobs with complex financial calculations, etc.)</p>
<p>Currently, it only runs on AWS, but we will keep an eye on it in the future. If I have time, I&rsquo;ll try to implement it on other clouds as well.</p></div><footer>
<div class=post>
<div class=post-share><div class=share-link>
<a class="share-icon share-twitter" href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://t4i5uKE.github.io/en/2021/12/karpenter-deep-dive/ data-title="Karpenter Deep Dive" data-via=m0rer0 data-hashtags="AWS,EKS,Kubernetes,Auto Scaling"><span class="svg-social-icon icon-twitter"></span></a>
</div><div class=share-link>
<a class="share-icon share-facebook" href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://t4i5uKE.github.io/en/2021/12/karpenter-deep-dive/ data-hashtag=AWS><span class="svg-social-icon icon-facebook"></span></a>
</div><div class=share-link>
<a class="share-icon share-line" href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://t4i5uKE.github.io/en/2021/12/karpenter-deep-dive/ data-title="Karpenter Deep Dive"><span class="svg-social-icon icon-line"></span></a>
</div><div class=share-link>
<a class="share-icon share-hackernews" href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://t4i5uKE.github.io/en/2021/12/karpenter-deep-dive/ data-title="Karpenter Deep Dive"><span class="svg-social-icon icon-hacker-news"></span></a>
</div></div>
<div class=post-tags><a href=/en/tags/aws/ class=tag>AWS</a><a href=/en/tags/eks/ class=tag>EKS</a><a href=/en/tags/kubernetes/ class=tag>Kubernetes</a><a href=/en/tags/auto-scaling/ class=tag>Auto Scaling</a></div></div>
</footer></div>
<div id=toc-final></div>
</div>
</article>
<section class="page single comments content-block-position">
<h1 class=display-hidden>Комментарии</h1><div id=comments></div></section></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line><i class="svg-icon icon-copyright"></i><span>2021 - 2022</span><span class=author>&nbsp;<a href=/en/ target=_blank></a></span>&nbsp;|&nbsp;<span class=license>t4i5uKE (morero)</span></div>
</div>
</footer></div>
<aside id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top">
<i class="svg-icon icon-arrow-up"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments">
<i class="svg-icon icon-comments-fixed"></i>
</a>
</aside><script src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script src=https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js></script><script src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script src=/lib/prismjs/prism.js></script><script>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{},search:{algoliaAppID:"PASDMWALPK",algoliaIndex:"index.en",algoliaSearchKey:"b42948e51daaa93df92381c8e2ac0f93",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"}}</script><script src=/js/theme.min.js></script></body>
</html>