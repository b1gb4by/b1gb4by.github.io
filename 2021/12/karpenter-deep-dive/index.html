<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Karpenter Deep Dive -</title><meta name=Description content="Let's take a deep dive into Karpenter"><meta property="og:title" content="Karpenter Deep Dive"><meta property="og:description" content="Let's take a deep dive into Karpenter"><meta property="og:type" content="article"><meta property="og:url" content="https://example.com/2021/12/karpenter-deep-dive/"><meta property="og:image" content="https://example.com/2021/12/karpenter-deep-dive/featured-image.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-16T20:47:40+09:00"><meta property="article:modified_time" content="2022-06-02T20:47:40+09:00"><meta property="og:site_name" content="A Life of Inquiry"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://example.com/2021/12/karpenter-deep-dive/featured-image.webp"><meta name=twitter:title content="Karpenter Deep Dive"><meta name=twitter:description content="Let's take a deep dive into Karpenter"><meta name=application-name content="Taisuke's Blog"><meta name=apple-mobile-web-app-title content="Taisuke's Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://example.com/2021/12/karpenter-deep-dive/><link rel=prev href=https://example.com/2021/09/device-configuration/><link rel=next href=https://example.com/2022/01/setup-rancher-desktop-on-mxlinux/><link rel=stylesheet href=/css/style.min.cf6878db51c51b2d04ae155284a4403dbee8db33e16c066f954c95279c271fcd.css integrity="sha256-z2h421HFGy0ErhVShKRAPb7o2zPhbAZvlUyVJ5wnH80="><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><meta name=google-site-verification content="MI9tWDvB5U3u_StKcJVdMhElMqisSGg7sJaKL0XmdMg"><meta name=p:domain_verify content="7a778e3261fcb3e1ab2f290745ddfb22"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Karpenter Deep Dive","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/example.com\/2021\/12\/karpenter-deep-dive\/"},"image":["https:\/\/example.com\/featured-image.webp"],"genre":"posts","keywords":"AWS, EKS, kubernetes, k8s, auto-scaling\u0022","wordcount":1788,"url":"https:\/\/example.com\/2021\/12\/karpenter-deep-dive\/","datePublished":"2021-12-16T20:47:40+09:00","dateModified":"2022-06-02T20:47:40+09:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"TaisukeOkamoto","logo":{"@type":"ImageObject","url":"https:\/\/example.com\/images\/avatar.png","width":650,"height":650}},"author":{"@type":"Person","name":"morero"},"description":"Let's take a deep dive into Karpenter"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title><span class=header-title-pre><i class='fa-solid fa-cubes fa-fw' aria-hidden=true></i></span>A Life of Inquiry</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class='fa-solid fa-book fa-fw' aria-hidden=true></i> Posts </a><a class=menu-item href=/tags/><i class='fa-solid fa-tags fa-fw' aria-hidden=true></i> Tags </a><a class=menu-item href=/categories/><i class='fa-solid fa-list fa-fw' aria-hidden=true></i> Categories </a><a class=menu-item href=/about/><i class='fa-solid fa-user-astronaut fa-fw' aria-hidden=true></i> About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="menu-item language" title="Select Language"><i class="fa fa-globe" aria-hidden=true></i>
<select class=language-select id=language-select-desktop onchange="location=this.value"><option value=/ja/2021/12/karpenter-deep-dive/>日本語</option><option value=/2021/12/karpenter-deep-dive/ selected>English</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title><span class=header-title-pre><i class='fa-solid fa-cubes fa-fw' aria-hidden=true></i></span>A Life of Inquiry</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title><i class='fa-solid fa-book fa-fw' aria-hidden=true></i>Posts</a><a class=menu-item href=/tags/ title><i class='fa-solid fa-tags fa-fw' aria-hidden=true></i>Tags</a><a class=menu-item href=/categories/ title><i class='fa-solid fa-list fa-fw' aria-hidden=true></i>Categories</a><a class=menu-item href=/about/ title><i class='fa-solid fa-user-astronaut fa-fw' aria-hidden=true></i>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class=menu-item title="Select Language"><i class="fa fa-globe fa-fw" aria-hidden=true></i>
<select class=language-select onchange="location=this.value"><option value=/ja/2021/12/karpenter-deep-dive/>日本語</option><option value=/2021/12/karpenter-deep-dive/ selected>English</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Karpenter Deep Dive</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://t4i5uke.github.io/ title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>morero</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2021-12-16>2021-12-16</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1788 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;9 minutes&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/2021/12/karpenter-deep-dive/featured-image.webp data-srcset="/2021/12/karpenter-deep-dive/featured-image.webp, /2021/12/karpenter-deep-dive/featured-image.webp 1.5x, /2021/12/karpenter-deep-dive/featured-image.webp 2x" data-sizes=auto alt=/2021/12/karpenter-deep-dive/featured-image.webp title="Let's take a deep dive into Karpenter"></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#what-is-karpenter>What is Karpenter?</a></li><li><a href=#autoscale-in-kubernetes>Autoscale in Kubernetes</a><ul><li><a href=#pod>Pod</a><ul><li><a href=#horizontal-pod-auto-scaler>Horizontal Pod Auto scaler</a></li><li><a href=#vertical-pod-auto-scaler>Vertical Pod Auto scaler</a></li></ul></li><li><a href=#node>Node</a><ul><li><a href=#cluster-auto-scaler>Cluster Auto scaler</a></li></ul></li></ul></li><li><a href=#how-to-install>How to install</a></li><li><a href=#configure-the-provisioner>Configure the provisioner</a><ul><li><a href=#unschedulable-pods>Unschedulable pods</a></li><li><a href=#provisioner-cr>Provisioner CR</a></li></ul></li><li><a href=#deprovisioning-node>Deprovisioning Node</a><ul><li><a href=#finalizer>Finalizer</a></li><li><a href=#node-expiry>Node Expiry</a></li><li><a href=#empty-nodes>Empty Nodes</a></li></ul></li><li><a href=#upgrade-node>Upgrade Node</a></li><li><a href=#constraints>Constraints</a></li><li><a href=#scheduling>Scheduling</a></li><li><a href=#cloud-provider>Cloud provider</a></li><li><a href=#difference-from-cluster-auto-scaler>Difference from Cluster Auto scaler</a><ul><li><a href=#designed-to-take-advantage-of-the-flexibility-of-the-cloud>Designed to take advantage of the flexibility of the cloud</a></li><li><a href=#group-less-node-provisioning>Group less Node Provisioning</a></li><li><a href=#scheduling-implementation>Scheduling Implementation</a></li></ul></li><li><a href=#thoughts>Thoughts</a></li></ul></nav></div></div><div class=content id=content><p>Recently, Karpenter graduated from AWS re:Invent with autoscaling of Nodes in Kubernetes clusters.</p><p>In this article, we&rsquo;ll take a deeper look at it.</p><h2 id=introduction>Introduction</h2><p>This is the 18th day of the [Kubernetes Advent Calendar 2021](&lt;(<a href=https://qiita.com/advent-calendar/2021/kubernetes%29%29 target=_blank rel="noopener noreffer">https://qiita.com/advent-calendar/2021/kubernetes))</a>.</p><h2 id=what-is-karpenter>What is Karpenter?</h2><p>Officially described as &ldquo;Just-in-time Nodes for Any Kubernetes Cluster&rdquo;, Karpenter provides the ability to instantly provision new Nodes for unscheduled Pods. The goal is to improve the efficiency and cost of running workloads on Kubernetes clusters.</p><p>Karpenter works as follows.</p><ul><li>Monitor Pods that the Kubernetes scheduler has marked as unschedulable</li><li>Evaluate the following scheduling constraints as requested by the Pod<ul><li>Resource Request</li><li>Node Selector</li><li>Affinity</li><li>Tolerant</li><li>Topology spreading constraints</li></ul></li><li>Provisioning a Node to meet Pod requirements</li><li>Scheduling a Pod to run on a new Node</li><li>Deleting a Node when it is no longer needed</li></ul><div class="details admonition info open"><div class="details-summary admonition-title"><i class="icon fas fa-info-circle fa-fw" aria-hidden=true></i>How to use Karpenter<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>Karpenter will only support AWS as of December 2021.</div></div></div><h2 id=autoscale-in-kubernetes>Autoscale in Kubernetes</h2><h3 id=pod>Pod</h3><p>There are two ways to scale the Pod.</p><h4 id=horizontal-pod-auto-scaler>Horizontal Pod Auto scaler</h4><p>Horizontal pod scaling is a method of scaling to improve processing performance by increasing the number of pods. User-defined metrics such as CPU, memory, etc. can also be used to make decisions.</p><p>The number of pods is calculated by the following formula.</p><data id=id-1 data-raw></data><h4 id=vertical-pod-auto-scaler>Vertical Pod Auto scaler</h4><p>This is a method of scaling that improves processing performance by increasing the resources available to the pod. In this case, the CPU and memory are used as criteria. It is more like optimizing the resource utilization.</p><h3 id=node>Node</h3><h4 id=cluster-auto-scaler>Cluster Auto scaler</h4><p>It is a method of scaling to improve processing performance by increasing the number of worker Nodes. It can also be used in conjunction with horizontal scaling of Pods.</p><h2 id=how-to-install>How to install</h2><p>Karpenter will be installed on the cluster with Helm Chart.
Karpenter also requires IAM Roles for Service Accounts (IRSA).</p><p>Currently, the utilities required to use Karpenter are as follows</p><ul><li><a href=https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html target=_blank rel="noopener noreffer">AWS CLI</a></li><li><code>kubectl</code><ul><li><a href=https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/ target=_blank rel="noopener noreffer">the Kubernetes CLI</a></li></ul></li><li><code>eksctl</code><ul><li><a href=https://docs.aws.amazon.com/eks/latest/userguide/eksctl.html target=_blank rel="noopener noreffer">the CLI for AWS EKS</a></li></ul></li><li><code>helm</code><ul><li><a href=https://karpenter.sh/docs/getting-started/#install target=_blank rel="noopener noreffer">the package manager for Kubernetes</a></li></ul></li></ul><p>To learn how to install Karpenter on AWS, please refer to the official document &ldquo;<a href=https://karpenter.sh/docs/getting-started/#install target=_blank rel="noopener noreffer">Getting Started with Karpenter on AWS</a>&rdquo;.</p><p>Karpenter&rsquo;s Helm Chart can be found <a href=https://github.com/aws/karpenter/tree/main/charts/karpenter target=_blank rel="noopener noreffer">here</a>.</p><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw" aria-hidden=true></i>Installation with Terraform<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>Kapenter also provides an installation method using <a href=https://learn.hashicorp.com/tutorials/terraform/install-cli target=_blank rel="noopener noreffer">Terraform</a>. See <a href=https://karpenter.sh/docs/getting-started-with-terraform/ target=_blank rel="noopener noreffer">here</a> for details.</div></div></div><p>An overview diagram is shown in the figure below.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./karpenter-overview.webp data-srcset="./karpenter-overview.webp, ./karpenter-overview.webp 1.5x, ./karpenter-overview.webp 2x" data-sizes=auto alt=./karpenter-overview.webp title="Karpenter Overview"></p><h2 id=configure-the-provisioner>Configure the provisioner</h2><p>Karpenter&rsquo;s job is to add Nodes that handle non-schedulable Pods, schedule Pods on those Nodes, and remove the Nodes when they are no longer needed.</p><p>To configure Karpenter, create a provisioner that defines how Karpenter will manage non-schedulable Pods and timed Nodes.</p><p>The following is what you need to know about Karpenter provisioners.</p><h3 id=unschedulable-pods>Unschedulable pods</h3><p>Karpenter will only attempt to provision Pods with the status condition <code>Unschedulable=True</code>. This will be set when the kube-scheduler fails to schedule a Pod to an existing capacity.</p><h3 id=provisioner-cr>Provisioner CR</h3><p>Karpenter defines a custom resource called <code>Provisioner</code> to specify the provisioning configuration.</p><p>Each provisioner manages a separate set of Nodes, but a Pod can be scheduled to any provisioner that supports its scheduling constraints.</p><p>A provisioner contains constraints that affect the Nodes that can be provisioned and the attributes of the Nodes (such as timers for removing Nodes).</p><p>The following are the resources of the provisioner.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>karpenter.sh/v1alpha5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ttlSecondsUntilExpired</span><span class=p>:</span><span class=w> </span><span class=m>2592000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ttlSecondsAfterEmpty</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>taints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>example.com/special-taint</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoSchedule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>billing-team</span><span class=p>:</span><span class=w> </span><span class=l>my-team</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>requirements</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;node.kubernetes.io/instance-type&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;m5.large&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;m5.2xlarge&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;topology.kubernetes.io/zone&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;us-west-2a&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;us-west-2b&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;kubernetes.io/arch&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;arm64&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;amd64&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;karpenter.sh/capacity-type&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;spot&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;on-demand&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>provider</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>The <code>spec.ttlSecondsUntilExpired</code> is the number of seconds the controller will wait before exiting the Node, measured from the time the Node is created. This is useful to eventually implement features like consistent Node upgrades, memory leak protection, and destructive testing. If this field is not set, termination due to expiration will be disabled.</p><p>The <code>spec.ttlSecondsAfterEmpty</code> is the number of seconds the controller will wait between the time it detects that a Node is empty and the time it tries to remove the Node. A Node is considered empty if there are no Pods scheduled for that Node, except for the daemonset.</p><p>The <code>spec.requirements</code> constrains the parameters of the provisioned Node. It can be combined with <code>nodeAffinity</code> and <code>nodeSelector</code>. The <code>{ In, NotIn }</code> operator is supported to include or exclude values.</p><h2 id=deprovisioning-node>Deprovisioning Node</h2><p>Karpenter deletes the nodes that are no longer needed as follows.</p><h3 id=finalizer>Finalizer</h3><p>Karpenter will place a finalizer bit in each Node it creates.</p><p>When a request to delete these Nodes comes in (such as a TTL or manual Node deletion via kubectl), Karpenter codes the Node, ejects all Pods, terminates the EC2 instance, and deletes the Node object.</p><p>Karpenter handles all the cleanup work required to properly delete the Node.</p><h3 id=node-expiry>Node Expiry</h3><p>When a Node reaches its expiration value (<code>ttlSecondsUntilExpired</code>), it will be ejected and removed from the Pod (even if it is still running a workload).</p><h3 id=empty-nodes>Empty Nodes</h3><p>When the last workload Pod running on a Karpenter-managed Node runs out, that Node will be given an <code>emptiness</code> timestamp. When its &ldquo;Node is empty&rdquo; expiration date (<code>ttlSecondsAfterEmpty</code>) is reached, finalization is triggered.</p><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw" aria-hidden=true></i>About how to remove Node<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>For more information on how Karpenter deletes Nodes, see <a href=https://karpenter.sh/docs/tasks/deprov-nodes/ target=_blank rel="noopener noreffer">Details</a> on Node deprovisioning.</div></div></div><h2 id=upgrade-node>Upgrade Node</h2><p>An easy way to upgrade a Node is to set <code>ttlSecondsUntilExpired</code>, which will expire after a set period of time and be replaced by a newer Node.</p><h2 id=constraints>Constraints</h2><p>Because there are no constraints defined by the provisioner or requested by the Pod being deployed, Karpenter is selected from the entire set of features available from the cloud provider. Nodes can be created using any instance type and run in any zone.</p><h2 id=scheduling>Scheduling</h2><p>Karpenter schedules Pods that are marked as <code>unschedulable</code> by the Kubernetes scheduler. After resolving scheduling constraints and startup capacity, it creates a Node and binds the Pod. This stateless approach will help you avoid race conditions and improve performance. If there is a problem with a launched Node, Kubernetes will automatically migrate the Pod to a new Node. When Karpenter launches a Node, it will also allow Kubernetes&rsquo; scheduler to schedule on it.</p><h2 id=cloud-provider>Cloud provider</h2><p>Karpenter makes a request to the relevant cloud provider for provisioning a new Node. The first supported cloud provider is AWS, but Karpenter is designed to work with other cloud providers as well. While using the well-known labels of Kubernetes, the provisioner can set a number of values specific to the cloud provider.</p><p>If you are developing your own provider, you can create it in the repository under <code>pkg/cloudprovider/</code>. The directory structure is as follows. The <code>fake</code> directory is provided as an example for reference.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── aws
</span></span><span class=line><span class=cl>│   ├── apis
</span></span><span class=line><span class=cl>│   │   └── v1alpha1
</span></span><span class=line><span class=cl>│   └── fake
</span></span><span class=line><span class=cl>├── fake
</span></span><span class=line><span class=cl>├── metrics
</span></span><span class=line><span class=cl>└── registry
</span></span></code></pre></td></tr></table></div></div><p>First, you need to create the following files for each cloud provider under <code>pkg/cloudprovider/registry</code> to register them.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// +build &lt;YOUR_PROVIDER_NAME&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/aws/karpenter/pkg/cloudprovider/&lt;YOUR_PROVIDER_NAME&gt;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewCloudProvider</span><span class=p>()</span> <span class=nx>cloudprovider</span><span class=p>.</span><span class=nx>CloudProvider</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>&lt;</span><span class=nx>YOUR_PROVIDER_NAME</span><span class=p>&gt;.</span><span class=nf>NewCloudProvider</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>You can also create one for each cloud provider under <code>pkg/cloudprovider</code> for your environment. If you check the <code>fake</code> directory, you will find the following files. You can add other necessary information according to your environment.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── cloudprovider.go
</span></span><span class=line><span class=cl>└── instancetype.go
</span></span></code></pre></td></tr></table></div></div><h2 id=difference-from-cluster-auto-scaler>Difference from Cluster Auto scaler</h2><p>Like Karpenter, the Kubernetes Cluster Auto scaler is designed to add Nodes when a request comes in to run a Pod that cannot be handled by the current capacity.
Cluster Auto scaler is part of the Kubernetes project and is implemented by most of the major Kubernetes cloud providers. By rethinking provisioning, Karpenter provides the following improvements.</p><h3 id=designed-to-take-advantage-of-the-flexibility-of-the-cloud>Designed to take advantage of the flexibility of the cloud</h3><p>Karpenter has the ability to efficiently handle any type of instance available in AWS. Cluster Autoscaler was not originally built with the flexibility to support hundreds of instance types, zones, and purchase options.</p><h3 id=group-less-node-provisioning>Group less Node Provisioning</h3><p>Karpenter manages each instance directly, without orchestration mechanisms such as Node groups. This allows you to retry in milliseconds instead of minutes if capacity is not available. It also allows you to take advantage of a variety of instance types, availability zones, and purchasing options without having to create hundreds of Node groups.</p><h3 id=scheduling-implementation>Scheduling Implementation</h3><p>Cluster Autoscaler does not bind a Pod to the Node it creates. Instead, it relies on the <code>kube-scheduler</code> to make the same scheduling decision after the Node comes online. The Node started by Karpenter is bound to its Pod immediately. kubelet<code> does not need to wait for the scheduler or Node to be ready. kubelet</code> does not need to wait for the scheduler or Node to be ready, it can start preparing the container runtime immediately, including pre-pulling images. This can reduce the Node startup latency by a few seconds.</p><h2 id=thoughts>Thoughts</h2><p>In this article, I&rsquo;ve tried to dig a little deeper into Karpenter.</p><p>Personally, I think it&rsquo;s the same as GKE Autopilot&rsquo;s dynamic Node provisioning process. I think Karpenter is an OSS version of that tool. Like GKE Autopilot, Karpenter observes the specification of non-schedulable pods, computes aggregate resource requests, and sends the requests to an underlying compute service (such as Amazon EC2) that has the capacity required to run all the pods.</p><p>Karpenter also allows you to define custom resources and specify the provisioning configuration for the following Nodes. We found the flexibility to change the configuration to be a significant advantage.</p><ul><li>Instance size/type, topology (zone, etc.)</li><li>Architecture (arm64, amd64, etc.)</li><li>Lifecycle type (spot, on-demand, pre-emptive, etc.)</li></ul><p>On the other hand, Karpenter can also deprovision a Node when it is no longer needed. This can be determined by setting the Node&rsquo;s expiration date (<code>ttlSecondsUntilExpired</code>) or when the last workload running on a Karpenter provisioned Node has finished (<code>ttlSecondsAfterEmpty</code>). Either of these two events triggers a finalization that codes the Node, ejects the Pod, terminates the underlying compute resource, and deletes the Node object. This deprovisioning feature can also be used to keep Node up-to-date with the latest AMI.</p><p>With Karpenter, I believe you can offload Node provisioning, autoscaling and upgrading and focus on running your application. Karpenter works with all kinds of Kubernetes applications, but I think it performs especially well in use cases where large amounts of diverse compute resources need to be provisioned and de-provisioned quickly. (Training machine learning models, running simulations, batch jobs with complex financial calculations, etc.)</p><p>Currently, it only runs on AWS, but we will keep an eye on it in the future. If I have time, I&rsquo;ll try to implement it on other clouds as well.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-06-02</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/2021/12/karpenter-deep-dive/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://example.com/2021/12/karpenter-deep-dive/ data-title="Karpenter Deep Dive" data-via=m0rer0 data-hashtags='AWS,EKS,kubernetes,k8s,auto-scaling"'><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://example.com/2021/12/karpenter-deep-dive/ data-hashtag=AWS><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://example.com/2021/12/karpenter-deep-dive/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://example.com/2021/12/karpenter-deep-dive/ data-title="Karpenter Deep Dive"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://example.com/2021/12/karpenter-deep-dive/><i class="fab fa-reddit fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://example.com/2021/12/karpenter-deep-dive/ data-title="Karpenter Deep Dive"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://example.com/2021/12/karpenter-deep-dive/ data-title="Karpenter Deep Dive"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/aws/>AWS</a>,&nbsp;<a href=/tags/eks/>EKS</a>,&nbsp;<a href=/tags/kubernetes/>kubernetes</a>,&nbsp;<a href=/tags/k8s/>k8s</a>,&nbsp;<a href=/tags/auto-scaling/>auto-scaling"</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/2021/09/device-configuration/ class=prev rel=prev title="About the device used"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>About the device used</a>
<a href=/2022/01/setup-rancher-desktop-on-mxlinux/ class=next rel=next title="Running Rancher Desktop on MXLinux">Running Rancher Desktop on MXLinux<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.104.3">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://t4i5uke.github.io/ target=_blank>morero</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},data:{"id-1":`
\\[希望するレプリカ数 = \\lceil {現在の Pod 数 \\times \\frac{現在の指標値}{ターゲットとする指標値}} \\rceil\\]
`},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"PASDMWALPK",algoliaIndex:"index.en",algoliaSearchKey:"b42948e51daaa93df92381c8e2ac0f93",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.b0df51c2c57145081cc73960e9aa780e6f5f56d06cf4ef0f96da8ce1619d1e12.js integrity="sha256-sN9RwsVxRQgcxzlg6ap4Dm9fVtBs9O8PltqM4WGdHhI="></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BRRNK5J7PW",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-BRRNK5J7PW" async></script></body></html>